name: Build FFmpeg (Commercial/Portable)

on:
  schedule:
    - cron: '0 0 * * *' # Run daily at midnight UTC
  workflow_dispatch:      # Allow manual trigger via "Run workflow" button

permissions:
  contents: write # Required to create Releases

jobs:
  check_version:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      version: ${{ steps.check.outputs.version }}
    steps:
      - name: Check latest FFmpeg Tag
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. Fetch latest tag matching 'n*' (e.g. n7.1) to ignore ancient 'v' tags
          LATEST_TAG=$(git ls-remote --tags --refs --sort='v:refname' https://git.ffmpeg.org/ffmpeg.git 'refs/tags/n*' | tail -n1 | awk -F/ '{print $3}')
          
          if [ -z "$LATEST_TAG" ]; then
            echo "Error: Could not find any valid FFmpeg tags."
            exit 1
          fi
          
          echo "Latest Upstream Tag: $LATEST_TAG"

          # 2. Check if this tag already exists in OUR releases
          HTTP_CODE=$(curl -o /dev/null -s -w "%{http_code}\n" \
            -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/$LATEST_TAG")
          
          if [ "$HTTP_CODE" == "200" ]; then
            echo "Release $LATEST_TAG already exists. Skipping build."
            echo "should_build=false" >> $GITHUB_OUTPUT
          else
            echo "New version $LATEST_TAG found. triggering build..."
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "version=$LATEST_TAG" >> $GITHUB_OUTPUT
          fi

  build:
    needs: check_version
    if: needs.check_version.outputs.should_build == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: windows-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup MSYS2 (UCRT64)
        uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          update: true
          # Note: 'mingw-w64-ucrt-x86_64-opus' is the correct name (no 'lib' prefix)
          install: >-
            base-devel git mingw-w64-ucrt-x86_64-toolchain
            mingw-w64-ucrt-x86_64-nasm mingw-w64-ucrt-x86_64-cmake
            mingw-w64-ucrt-x86_64-vulkan-headers mingw-w64-ucrt-x86_64-vulkan-loader
            mingw-w64-ucrt-x86_64-shaderc mingw-w64-ucrt-x86_64-libplacebo
            mingw-w64-ucrt-x86_64-ffnvcodec-headers mingw-w64-ucrt-x86_64-amf-headers
            mingw-w64-ucrt-x86_64-opus mingw-w64-ucrt-x86_64-libvpx
            mingw-w64-ucrt-x86_64-svt-av1

      - name: Compile FFmpeg
        shell: msys2 {0}
        run: |
          # 1. Clone the specific tag found in the check_version step
          git clone --depth 1 --branch ${{ needs.check_version.outputs.version }} https://git.ffmpeg.org/ffmpeg.git ffmpeg_src
          cd ffmpeg_src
          
          # 2. Configure (Commercial/LGPL/Hardware Optimized Command)
          ./configure --prefix=../install --arch=x86_64 --target-os=mingw64 \
            --enable-shared --disable-static --disable-programs --disable-doc --disable-debug --disable-everything \
            --disable-gpl --disable-nonfree --enable-version3 \
            --enable-vulkan --enable-ffnvcodec --enable-nvenc --enable-nvdec --enable-cuda-llvm --enable-amf \
            --enable-libshaderc --enable-libplacebo \
            --enable-encoder=av1_nvenc --enable-encoder=av1_amf --enable-encoder=av1_vulkan --enable-encoder=libsvtav1 \
            --enable-encoder=h264_nvenc --enable-encoder=hevc_nvenc --enable-encoder=h264_amf --enable-encoder=hevc_amf \
            --enable-encoder=h264_vulkan --enable-encoder=hevc_vulkan \
            --enable-encoder=libvpx_vp9 --enable-encoder=libopus \
            --enable-decoder=h264 --enable-decoder=hevc --enable-decoder=av1 --enable-decoder=vp9 --enable-decoder=vp8 --enable-decoder=opus \
            --enable-hwaccel=h264_nvdec --enable-hwaccel=hevc_nvdec --enable-hwaccel=av1_nvdec --enable-hwaccel=vp9_nvdec \
            --enable-hwaccel=h264_vulkan --enable-hwaccel=hevc_vulkan --enable-hwaccel=av1_vulkan --enable-hwaccel=vp9_vulkan \
            --enable-filter=scale --enable-filter=scale_cuda --enable-filter=scale_vulkan --enable-filter=format --enable-filter=libplacebo \
            --enable-avcodec --enable-avdevice --enable-avfilter --enable-avformat --enable-swresample --enable-swscale \
            --enable-libvpx --enable-libopus --enable-libsvtav1 \
            --enable-demuxer=mov --enable-demuxer=matroska --enable-demuxer=webm --enable-demuxer=image2 --enable-demuxer=ogg \
            --enable-muxer=mp4 --enable-muxer=matroska --enable-muxer=webm --enable-muxer=hls --enable-muxer=dash --enable-muxer=mpegts --enable-muxer=image2 --enable-muxer=ogg \
            --enable-parser=av1 --enable-parser=vp9 --enable-parser=vp8 --enable-parser=opus --enable-parser=h264 --enable-parser=hevc \
            --enable-bsf=h264_mp4toannexb --enable-bsf=hevc_mp4toannexb \
            --enable-protocol=file --enable-protocol=http --enable-protocol=tcp --enable-protocol=pipe
          
          # 3. Build & Install
          make -j$(nproc)
          make install

      - name: Bundle Dependencies (Make Portable)
        shell: msys2 {0}
        run: |
          mkdir dist
          # Copy FFmpeg DLLs
          cp install/bin/*.dll dist/
          
          # Find and copy all system dependencies (vulkan, opus, etc)
          # We filter for /ucrt64/bin/ to avoid copying system windows files
          ldd install/bin/avcodec-*.dll | grep '/ucrt64/bin/' | awk '{print $3}' | sort | uniq | xargs -I '{}' cp '{}' dist/

      - name: Zip Artifacts
        run: Compress-Archive -Path dist/* -DestinationPath ffmpeg-portable-${{ needs.check_version.outputs.version }}.zip

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.check_version.outputs.version }}
          name: FFmpeg ${{ needs.check_version.outputs.version }} (Portable)
          files: ffmpeg-portable-${{ needs.check_version.outputs.version }}.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}