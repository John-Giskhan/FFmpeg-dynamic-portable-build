name: Build FFmpeg SDK (Stable)

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check_version:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      version: ${{ steps.check.outputs.version }}
    steps:
      - name: Find Latest Stable Tag
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Fetch tags, filter for 'n7.1' style, sort versions
          LATEST_TAG=$(git ls-remote --tags --refs --sort='v:refname' https://git.ffmpeg.org/ffmpeg.git 'refs/tags/n*' \
            | awk -F/ '{print $3}' \
            | grep -E '^n[0-9]+\.[0-9]+(\.[0-9]+)?$' \
            | tail -n1)
          
          if [ -z "$LATEST_TAG" ]; then
            echo "Error: Could not find a valid stable FFmpeg tag."
            exit 1
          fi
          
          # Check if release exists
          HTTP_CODE=$(curl -o /dev/null -s -w "%{http_code}\n" \
            -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/$LATEST_TAG")
          
          if [ "$HTTP_CODE" == "200" ]; then
            echo "Build exists for $LATEST_TAG. Skipping."
            echo "should_build=false" >> $GITHUB_OUTPUT
          else
            echo "New version $LATEST_TAG. Building..."
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "version=$LATEST_TAG" >> $GITHUB_OUTPUT
          fi

  build:
    needs: check_version
    if: needs.check_version.outputs.should_build == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: windows-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSYS2 (UCRT64)
        uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          update: true
          install: >-
            base-devel git mingw-w64-ucrt-x86_64-toolchain
            mingw-w64-ucrt-x86_64-nasm mingw-w64-ucrt-x86_64-cmake
            mingw-w64-ucrt-x86_64-vulkan-headers mingw-w64-ucrt-x86_64-vulkan-loader
            mingw-w64-ucrt-x86_64-shaderc mingw-w64-ucrt-x86_64-libplacebo
            mingw-w64-ucrt-x86_64-ffnvcodec-headers mingw-w64-ucrt-x86_64-amf-headers
            mingw-w64-ucrt-x86_64-opus mingw-w64-ucrt-x86_64-libvpx
            mingw-w64-ucrt-x86_64-svt-av1

      - name: Compile FFmpeg
        shell: msys2 {0}
        run: |
          git clone --depth 1 --branch ${{ needs.check_version.outputs.version }} https://git.ffmpeg.org/ffmpeg.git ffmpeg_src && cd ffmpeg_src && \
          ./configure --prefix=../install --arch=x86_64 --target-os=mingw64 \
            --enable-shared --disable-static --disable-programs --disable-doc --disable-debug --disable-everything \
            --disable-gpl --disable-nonfree --enable-version3 \
            --enable-vulkan --enable-ffnvcodec --enable-nvenc --enable-nvdec --enable-amf \
            --enable-libshaderc --enable-libplacebo \
            --enable-encoder=av1_nvenc --enable-encoder=av1_amf --enable-encoder=av1_vulkan --enable-encoder=libsvtav1 \
            --enable-encoder=h264_nvenc --enable-encoder=hevc_nvenc --enable-encoder=h264_amf --enable-encoder=hevc_amf \
            --enable-encoder=h264_vulkan --enable-encoder=hevc_vulkan \
            --enable-encoder=libvpx_vp9 --enable-encoder=libopus \
            --enable-decoder=h264 --enable-decoder=hevc --enable-decoder=av1 --enable-decoder=vp9 --enable-decoder=vp8 --enable-decoder=opus \
            --enable-hwaccel=h264_nvdec --enable-hwaccel=hevc_nvdec --enable-hwaccel=av1_nvdec --enable-hwaccel=vp9_nvdec \
            --enable-hwaccel=h264_vulkan --enable-hwaccel=hevc_vulkan --enable-hwaccel=av1_vulkan --enable-hwaccel=vp9_vulkan \
            --enable-filter=scale --enable-filter=scale_vulkan --enable-filter=format --enable-filter=libplacebo \
            --enable-avcodec --enable-avdevice --enable-avfilter --enable-avformat --enable-swresample --enable-swscale \
            --enable-libvpx --enable-libopus --enable-libsvtav1 \
            --enable-demuxer=mov --enable-demuxer=matroska --enable-demuxer=webm --enable-demuxer=image2 --enable-demuxer=ogg \
            --enable-muxer=mp4 --enable-muxer=matroska --enable-muxer=webm --enable-muxer=hls --enable-muxer=dash --enable-muxer=mpegts --enable-muxer=image2 --enable-muxer=ogg \
            --enable-parser=av1 --enable-parser=vp9 --enable-parser=vp8 --enable-parser=opus --enable-parser=h264 --enable-parser=hevc \
            --enable-bsf=h264_mp4toannexb --enable-bsf=hevc_mp4toannexb \
            --enable-protocol=file --enable-protocol=http --enable-protocol=tcp --enable-protocol=pipe && \
          make -j$(nproc) && \
          make install

      - name: üîç PRINT LOGS ON FAILURE
        if: failure()
        shell: msys2 {0}
        run: |
          echo "=== CONFIG.LOG ==="
          cat ffmpeg_src/ffbuild/config.log || echo "config.log not found"

      - name: Package SDK (Headers + DLLs + Libs)
        shell: msys2 {0}
        run: |
          mkdir -p dist/bin dist/include dist/lib
          
          # 1. Copy Headers (From make install)
          cp -r install/include/* dist/include/
          
          # 2. Copy DLLs (From make install)
          cp install/bin/*.dll dist/bin/
          
          # 3. Smart Bundle
          # Finds system DLLs (vulkan, opus) and copies them to bin/
          ldd install/bin/avcodec-*.dll | grep '/ucrt64/bin/' | awk '{print $3}' | sort | uniq | xargs -I '{}' cp '{}' dist/bin/
          
          # 4. MSVC Linker Fix
          # Copies the MSVC-compatible .lib files generated in the source tree
          echo "Copying MSVC .lib files..."
          cp ffmpeg_src/libavcodec/avcodec.lib       dist/lib/
          cp ffmpeg_src/libavdevice/avdevice.lib     dist/lib/
          cp ffmpeg_src/libavfilter/avfilter.lib     dist/lib/
          cp ffmpeg_src/libavformat/avformat.lib     dist/lib/
          cp ffmpeg_src/libavutil/avutil.lib         dist/lib/
          cp ffmpeg_src/libswresample/swresample.lib dist/lib/
          cp ffmpeg_src/libswscale/swscale.lib       dist/lib/

      - name: Zip SDK
        run: Compress-Archive -Path dist/* -DestinationPath ffmpeg-sdk-${{ needs.check_version.outputs.version }}.zip

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.check_version.outputs.version }}
          name: FFmpeg SDK ${{ needs.check_version.outputs.version }} (Portable + MSVC)
          files: ffmpeg-sdk-${{ needs.check_version.outputs.version }}.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}